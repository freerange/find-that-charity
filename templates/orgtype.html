{% extends 'base.html' %}
{% set heading = query|list_to_string %}
{% set selected_org_type = query|list_to_string %}
{% if pages.last_page and pages.last_page > 1 %}
    {% set subtitle = "Showing organisation {:,.0f} to {:,.0f} out of {:,.0f}".format(
        pages.start_item,
        pages.end_item,
        pages.total_items
    ) %}
{% else %}
    {% set subtitle = "Showing all {:,.0f} organisations".format(pages.total_items) %}
{% endif %}

{% block content %}
<main class="">
    <form class="" action="{{ request.url.remove_query_params('q') }}">
        <div class="fl w-100 w-70-l pa2">
            <div class="cf mb3 flex">
                <input name="q" class="f6 f5-l input-reset bl bt bb br br-0 b--black-20 fl near-black bg-white pa3 lh-solid w-100 w-80-ns br2-ns br--left-ns" type="text" placeholder="Search these organisations"
                    value="{{term or ''}}" autocomplete='off'>
                <input type="submit" value="Search" class="f6 f5-l button-reset br bt bb bl-0 b--black-20 fl pv3 tc bg-animate bg-yellow dim near-black pointer w-100 w-20-m w-20-l br2-ns br--right-ns">
            </div>
            {% if 'orgtype' in request.query_params.keys() or 'source' in request.query_params.keys() %}
            <div class="w-100 mb4">
                <span class="f6 b mr2">Filters: </span>
                {% for r in request.query_params.getlist('orgtype') %}
                <span class="bg-moon-gray b--dark-gray bw1 ba mr2 mb2 dib f6 br-pill pv1 ph2">
                    Type: 
                    {{ r }}
                </span>
                {% endfor %}
                {% for r in request.query_params.getlist('source') %}
                <span class="bg-moon-gray b--dark-gray bw1 ba mr2 mb2 dib f6 br-pill pv1 ph2">
                    Source: 
                    {{ r }}
                </span>
                {% endfor %}
                <a href="{{ request.url.remove_query_params(['orgtype', 'source']) }}" class="f6 link blue underline">Clear filters</a>
            </div>
            {% endif %}
            {# {% include '_search_form.html' %} #}
            {% include '_search_results.html' %}
        </div>
        <div class="fl w-100 w-30-l pa2">
            <label class="mb3 dib lh-title">
                <input type='checkbox' class="mr1" name="inactive" value="include_inactive" />
                Include inactive organisations
            </label>
            <h4 class="ma0 pa0">Related organisation types</h4>
            <ul class="mb4 mt2 list mh0 pa0 lh-title">
            {% for t in aggs.group_by_type.buckets if t.key in key_types %}
                <li class="w-100 f4 mb2">
                    <div class="">
                        <a class="link dark-blue underline-hover mr3" href="{{ request.url.include_query_params(orgtype=t.key) }}">{{ t.key }}</a>
                        <span class="mid-gray">{{ "{:,.0f}".format(t.doc_count) }}</span>
                    </div>
                </li>
            {% endfor %}
            {% for t in aggs.group_by_type.buckets if t.key not in key_types %}
                <li class="w-100 f5 mb2">
                    <div class="">
                        <a class="link dark-blue underline-hover mr3" href="{{ request.url.include_query_params(orgtype=t.key) }}">{{ t.key }}</a>
                        <span class="mid-gray">{{ "{:,.0f}".format(t.doc_count) }}</span>
                    </div>
                </li>
            {% endfor %}
            </ul>
            <h4 class="ma0 pa0">Data sources</h4>
            <ul class="mb4 mt2 list mh0 pa0">
            {% for t in aggs.group_by_source.buckets if sources.get(t.key) %}
                <li class="w-100 f4">
                    <div class="lh-title">
                        <a class="link dark-blue underline-hover mr3 lh-title" href="{{ request.url.include_query_params(source=t.key) }}">{{ sources[t.key].publisher.name }}</a>
                        <span class="mid-gray">{{ "{:,.0f}".format(t.doc_count) }}</span>
                    </div>
                </li>
            {% endfor %}
            </ul>
        </div>
    </form>
</main>
{% endblock %}