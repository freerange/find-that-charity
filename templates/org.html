{% extends 'base.html' %}
{% set heading = orgs["name"] %} 
{% set subtitle = "Org ID: {}{}".format(
    orgs["id"],
    "" if orgs.active else " | Inactive"
) %}

{% macro show_sources(v) %}
<span class="has-text-weight-light is-size-7">
  [{{ v["sources"]|sources_to_string }}]
</span>
{% endmacro %}

{% block content %}
<div class="columns">
  <div class="column">
    <div class="tags are-medium">
      {% for k, v in orgs.data.organisationType.items() if k in key_types %}
      <a class="tag is-medium is-info" href="/orgid/type/{{ v.value }}">{{ v.value }}</a>
      {% endfor %}
    </div>
    <div class="tags are-medium">
      {% for k, v in orgs.data.organisationType.items() if k not in key_types %}
      <a class="tag is-small is-light" href="/orgid/type/{{ v.value }}">{{ v.value }}</a>
      {% endfor %}
    </div>
    {% if orgs.data.description.keys()|length %}
    <h3>Description</h3>
    {% for k, v in orgs.data.description.items() %}
    <p>
      {{ v.value }}
      {{ show_sources(v) }}
    </p>
    {% endfor %}
    <br>
    {% endif %}
    <div class="card">
      <header class="card-header">
        <p class="card-header-title">Alternative names</p>
      </header>
      <div class="card-content">
        <div class="content">
          <table class="table">
            <tbody>
              <tr>
                <th>Name</th>
                <th>Source</th>
              </tr>
              {% for k, v in orgs.data.name.items()|list + orgs.data.alternateName.items()|list %}
              <tr>
                <td>{{ v.value }}</td>
                <td>{{ show_sources(v) }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <br>
    <div class="card">
      <header class="card-header">
        <p class="card-header-title">Links</p>
      </header>
      <div class="card-content">
        <div class="content">
          <ul>
            {% for k, v in orgs.data.url.items() %}
            <li><a href="{{ v.value }}" target="_blank">Organisation website</a> {{ show_sources(v) }}</li>
            {% endfor %}
            {% for k, v in orgs.data.orgIDs.items() %}
              {% if v.value.startswith("GB-CHC-") %}
                {% set charity_number = v.value.replace('GB-CHC-', '') %}
                <li><a href="http://apps.charitycommission.gov.uk/Showcharity/RegisterOfCharities/SearchResultHandler.aspx?RegisteredCharityNumber={{ charity_number }}&SubsidiaryNumber=0&Ref=CO" target="_blank">Charity Commission England and Wales</a></li>
                <li><a href="http://beta.charitycommission.gov.uk/charity-details/?regid={{charity_number}}&subid=0" target="_blank">Charity Commission England and Wales (beta)</a></li>
                <li><a href="https://charitybase.uk/charities/{{charity_number}}" target="_blank">CharityBase</a></li>
                <li><a href="http://opencharities.org/charities/{{charity_number}}" target="_blank">OpenCharities</a></li>
                <li><a href="http://www.guidestar.org.uk/summary.aspx?CCReg={{charity_number}}" target="_blank">GuideStar</a></li>
                <li><a href="http://www.charitychoice.co.uk/charities/search?t=qsearch&q={{charity_number}}" target="_blank">Charities Direct</a></li>
                <li><a href="https://olib.uk/charity/html/{{charity_number}}" target="_blank">CharityData by Olly Benson</a></li>
              {% endif %}
              {% if v.value.startswith("GB-NIC-") %}
                <li><a href="http://www.charitycommissionni.org.uk/charity-details/?regid={{ v.value.replace('GB-NIC-', '').replace('NIC', '')}}&subid=0" target="_blank">Charity Commission Northern Ireland</a></li>
              {% endif %}
              {% if v.value.startswith("GB-SC-") %}
              <li><a href="https://www.oscr.org.uk/about-charities/search-the-register/charity-details?number={{ v.value.replace('GB-SC-', '') }}" target="_blank">Office of the Scottish Charity Register</a></li>
              {% endif %}
              {% if v.value.startswith("GB-EDU-") %}
              <li><a href="https://get-information-schools.service.gov.uk/Establishments/Establishment/Details/{{ v.value.replace('GB-EDU-', '') }}" target="_blank">Get information about schools</a></li>
              {% endif %}
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>
  <div class="column">
    <div class="card">
      <header class="card-header">
        <p class="card-header-title">
          Organisation identifiers
        </p>
      </header>
      <div class="card-content">
        <div class="content">
          <p>
            Organisation identifiers are based on the org-id scheme.
            <a href="http://org-id.guide/about" target="_blank" class="has-text-weight-light">Find out more about org-id</a>
          </p>
          <table class="table">
            <tbody>
              {% for k, v in orgs.data.orgIDs.items() %}
              {% set org_id_scheme = "-".join(v.value.split("-")[0:2]) %}
              <tr>
                <td><a href="http://org-id.guide/list/{{ org_id_scheme }}" target="_blank">{{ org_id_scheme }}</a></td>
                <td>{{ v.value }}</td>
                <td>{{ show_sources(v) }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <br>
    <div class="card">
      <header class="card-header">
        <p class="card-header-title">Registration details</p>
      </header>
      <div class="card-content">
        <div class="content">
          <table class="table">
            <tbody>
            {% for k, v in orgs.data.orgIDs.items() %}
              {% if v.value.startswith("GB-COH-") %}
                <tr>
                  <th>Company number</th>
                  <td>
                    <a href="https://beta.companieshouse.gov.uk/company/{{ v.value.replace('GB-COH-', '') }}" target="_blank">{{ v.value.replace('GB-COH-', '') }}</a>
                  </td>
                  <td>{{ show_sources(v) }}</td>
                </tr>
              {% endif %}
              {% if v.value.startswith("GB-CHC-") %}
                <tr>
                  <th>CCEW Charity number</th>
                  <td>
                    <a href="http://beta.charitycommission.gov.uk/charity-details/?regid={{ v.value.replace('GB-CHC-', '') }}&subid=0" target="_blank">{{ v.value.replace('GB-CHC-', '') }}</a>
                  </td>
                  <td>{{ show_sources(v) }}</td>
                </tr>
              {% endif %}
              {% if v.value.startswith("GB-NIC-") %}
                <tr>
                  <th>CCNI Charity number</th>
                  <td>
                    <a href="http://www.charitycommissionni.org.uk/charity-details/?regid={{ v.value.replace('GB-NIC-', '').replace('NIC', '')}}&subid=0" target="_blank">{{ v.value.replace('GB-NIC-', '') }}</a>
                  </td>
                  <td>{{ show_sources(v) }}</td>
                </tr>
              {% endif %}
              {% if v.value.startswith("GB-SC-") %}
                <tr>
                  <th>OSCR Charity number</th>
                  <td>
                    <a href="https://www.oscr.org.uk/about-charities/search-the-register/charity-details?number={{ v.value.replace('GB-SC-', '') }}" target="_blank">{{ v.value.replace('GB-SC-', '') }}</a>
                  </td>
                  <td>{{ show_sources(v) }}</td>
                </tr>
              {% endif %}
            {% endfor %}
            </tbody>
          </table>
          {% for org in orgs.orgs %}
          <p>
            <strong>{{ org.name }}</strong>
            ({{ org.id }})
            {{ show_sources(org) }}
          </p>
          <div class="tags are-small">
            {% for t in org.organisationType %}
            <span class="tag is-small">{{ t }}</span>
            {% endfor %}
          </div>
          <table class="table">
            <tbody>
              <tr>
                <th>Active</th>
                <td>{% if org.active %}Yes{% else %}No{% endif %}</td>
              </tr>
              {% if org.dateRegistered %}
              <tr>
                <th>Registered</th>
                <td>{{ "{:%d %B %Y}".format(org.dateRegistered) }}</td>
              </tr>
              {% endif %}
              {% if org.dateRemoved %}
              <tr>
                <th>Removed</th>
                <td>{{ "{:%d %B %Y}".format(org.dateRemoved) }}</td>
              </tr>
              {% endif %}
            </tbody>
          </table>
          {% endfor %}
        </div>
      </div>
    </div>
    <br>
    <div class="card">
      <header class="card-header">
        <p class="card-header-title">Other details</p>
      </header>
      <div class="card-content">
        <div class="content">
          <table class="table">
            <tbody>
              {# <tr>
                <th>Postcode</th>
                <td>{{ o.get("geo", {}).get("postcode") }}</td>
              </tr> #}
              {% for k, v in orgs.data.url.items() %}
              <tr>
                {% if loop.index0 == 0 %}
                <th rowspan="{{ loop.length }}">Website</th>
                {% endif %}
                <td><a href="{{ v.value }}">{{ v.value }}</a></td>
                <td>{{ show_sources(v) }}</td>
              </tr>
              {% endfor %}
              {# <tr>
                <th>Domain</th>
                <td><code>{{ charity["domain"] }}</code></td>
              </tr> #}
              {% for k, v in orgs.data.latestIncome.items() %}
              <tr>
                {% if loop.index0 == 0 %}
                <th rowspan="{{ loop.length }}">Latest income</th>
                {% endif %}
                <td>
                {% if v.value %}
                  &pound;{{ "{:,.0f}".format( v.value )}}
                {% else %}
                  <code>Unknown</code>
                {% endif %}
                </td>
                <td>{{ show_sources(v) }}</td>
              </tr>
              {% endfor %}
              {% for k, v in orgs.data.dateModified.items() %}
              <tr>
                {% if loop.index0 == 0 %}
                <th rowspan="{{ loop.length }}">Last modified</th>
                {% endif %}
                <td>{{ "{:%Y-%m-%d}".format(v.value) }}</td>
                <td>{{ show_sources(v) }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <br>
    {# {% if charity["geo"]["location"] %}
    <div class="card">
      <header class="card-header">
        <p class="card-header-title">Location</p>
      </header>
      <div class="card-content">
        <div class="content">
          <table class="table">
            <tbody>
              {% if charity.get("geo", {}).get("location") %}
              <tr>
                <th>Latitude/longitude</th>
                <td>
                  <a href="#">
                     {{ charity.get("geo", {}).get("location",{}).get("lat") }},
                     {{ charity.get("geo", {}).get("location",{}).get("lon") }}
                  </a>
                </td>
              </tr>
              {% endif %}
              <!--<tr><th>Local Authority</th><td>{{ charity.get("geo", {}).get("areas",[]) }}</td></tr>-->
              <tr><th>Postcode</th><td>{{ charity.get("geo", {}).get("postcode") }}</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {% endif %} #}

  </div>
</div>
<div class="columns">
  <div class="column">
    <div class="card">
      <header class="card-header">
        <p class="card-header-title">Data sources</p>
      </header>
      <div class="card-content">
        <div class="content">
          <table class="table">
            <tbody>
              {% for s in orgs.sources if sources.get(s) %}
              <tr id="{{ s }}">
                <td>
                  <strong><a href="{{ sources[s].publisher.website }}">{{ sources[s].publisher.name }}</a></strong><br>
                  {% if sources[s].title != sources[s].publisher.name %}
                  {{ sources[s].title }}
                  {% endif %}
                </td>
                <td class="is-size-7">{{ sources[s].description }}</td>
                <td>{{ "{:%Y-%m-%d}".format(sources[s].modified) }}</td>
                <td><a href="{{ sources[s].license }}">{{ sources[s].license_name }}</a></td>
                <td>
                {% for d in sources[s].distribution %}
                  <a class="button is-small" href="{{ d.downloadURL }}">Download data</a><br>
                  <a class="button is-small" href="{{ d.accessURL }}">View data</a>
                {% endfor %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}