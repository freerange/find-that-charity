{% extends 'base.html' %}
{% set heading = orgs["name"] %} 
{% set subtitle = "Org ID: {}{}".format(
    orgs["id"],
    "" if orgs.active else " | Inactive"
) %}

{% macro show_sources(v) %}
<span class="has-text-weight-light is-size-7">
  [{{ v["sources"]|list_to_string }}]
</span>
{% endmacro %}

  {% block subtitle %}
  <section class="hero is-primary is-bold">
      <div class="hero-body">
          <div class="container">
            <h1 class="title">
                {{ orgs["name"] }}
            </h1>
            <div class="field is-grouped is-grouped-multiline">
              {% for k, v in orgs.data.orgIDs.items() %}
              {% set org_id = v.value.split("-") %}
              <div class="control">
                <div class="tags has-addons" title="Organisation identifier">
                  {# <a href="http://org-id.guide/list/{{ '-'.join(org_id[0:2]) }}" target="_blank" class="tag is-dark is-medium">{{ "-".join(org_id[0:2]) }}</a> #}
                  <a href="/orgid/{{ v.value }}" class="tag is-dark is-medium">{{ "-".join(org_id) }}</a>
                </div>
              </div>
              {% endfor %}
              {# <div class="control">
                <div class="tags has-addons">
                  <a class="tag is-primary is-medium">?</a>
                </div>
              </div> #}
            </div>
            <div class="tags are-medium">
              {% for k, v in orgs.data.organisationType.items() if k in key_types %}
              <a class="tag is-medium is-info" href="/orgid/type/{{ v.value }}">{{ v.value }}</a>
              {% endfor %}
            </div>
          </div>
      </div>
  </section>
  {% endblock %}

{% block content %}
<div class="columns">
  <div class="column">
    <div class="tags are-medium">
      {% for k, v in orgs.data.organisationType.items() if k not in key_types %}
      <a class="tag is-small is-light" href="/orgid/type/{{ v.value }}">{{ v.value }}</a>
      {% endfor %}
    </div>
    {% if orgs.data.description.keys()|length %}
    <div class="content">
      <h4>Description</h4>
      {% for k, v in orgs.data.description.items() %}
      <p>
        {{ v.value }}
        {{ show_sources(v) }}
      </p>
      {% endfor %}
      {% if orgs.names %}
      <h4>Other names</h4>
      <ul>
        {% for k, v in orgs.names.items() %}
        <li>{{ v.value }} {{ show_sources(v) }}</li>
        {% endfor %}
      </ul>
      {% endif %}
    </div>
    <br>
    {% endif %}

  </div>
  <div class="column is-one-third">

    {% if orgs.data.url or orgs.links %}
    <article class="message is-info">
      <div class="message-header">
        <p class="">Links</p>
      </div>
      <div class="message-body">
        <ul>
          {% for k, v in orgs.data.url.items() %}
          <li><a href="{{ v.value }}" target="_blank">Organisation website</a> {{ show_sources(v) }}</li>
          {% endfor %}
          {% for link, text in orgs.links %}
          <li><a href="{{ link }}" target="_blank">{{ text }}</a></li>
          {% endfor %}
        </ul>
      </div>
    </article>
    {% endif %}

  </div>
</div>
<div class="columns">
    
  {% for org in orgs.orgs %}
  <div class="column is-one-third">
    <div class="card">
      <header class="card-header">
        <p class="card-header-title">
          Organisation record  
          {# {% for s in org.sources if sources.get(s) %}
          <span class="is-size-7 has-text-weight-light pull-right"> ({{ sources[s].publisher.name }})</span>
          {% endfor %} #}
        </p>
      </header>
      <div class="card-content">
        <div class="content">
          <p>
            <strong>{{ org.name }}</strong> ({{ org.id }})
          </p>
          <div class="tags are-small">
            {% for t in org.organisationType %}
            <span class="tag is-small">{{ t }}</span>
            {% endfor %}
          </div>
          <table class="table">
            <tbody>
            {% for v in org.orgIDs %}
              {% if v.startswith("GB-COH-") %}
                <tr>
                  <td>Company number</td>
                  <td>
                    <a href="https://beta.companieshouse.gov.uk/company/{{ v.replace('GB-COH-', '') }}" target="_blank">{{ v.replace('GB-COH-', '') }}</a>
                  </td>
                </tr>
              {% endif %}
              {% if v.startswith("GB-CHC-") %}
                <tr>
                  <td>CCEW Charity number</td>
                  <td>
                    <a href="http://beta.charitycommission.gov.uk/charity-details/?regid={{ v.replace('GB-CHC-', '') }}&subid=0" target="_blank">{{ v.replace('GB-CHC-', '') }}</a>
                  </td>
                </tr>
              {% endif %}
              {% if v.startswith("GB-NIC-") %}
                <tr>
                  <td>CCNI Charity number</td>
                  <td>
                    <a href="http://www.charitycommissionni.org.uk/charity-details/?regid={{ v.replace('GB-NIC-', '').replace('NIC', '')}}&subid=0" target="_blank">{{ v.replace('GB-NIC-', '') }}</a>
                  </td>
                </tr>
              {% endif %}
              {% if v.startswith("GB-SC-") %}
                <tr>
                  <td>OSCR Charity number</td>
                  <td>
                    <a href="https://www.oscr.org.uk/about-charities/search-the-register/charity-details?number={{ v.replace('GB-SC-', '') }}" target="_blank">{{ v.replace('GB-SC-', '') }}</a>
                  </td>
                </tr>
              {% endif %}
            {% endfor %}
              <tr>
                <td>
                  Identifiers<br>
                  <span class="is-size-7">(using <a href="http://org-id.guide/about" target="_blank" class="">org-id</a>)</span>
                </td>
                <td>
                {% for orgid in org.orgIDs %}
                  {{orgid}}<br>
                {% endfor %}
                </td>
              </tr>
              <tr>
                <td>Active</td>
                <td>{% if org.active %}Yes{% else %}No{% endif %}</td>
              </tr>
              {% if org.dateRegistered %}
              <tr>
                <td>Registered</td>
                <td>{{ "{:%d %B %Y}".format(org.dateRegistered) }}</td>
              </tr>
              {% endif %}
              {% if org.dateRemoved %}
              <tr>
                <td>Removed</td>
                <td>{{ "{:%d %B %Y}".format(org.dateRemoved) }}</td>
              </tr>
              {% endif %}
              {# <tr>
                <td>Postcode</td>
                <td>{{ o.get("geo", {}).get("postcode") }}</td>
              </tr> #}
              {% if org.url %}
              <tr>
                <td>Website</td>
                <td><a href="{{ org.url }}">{{ org.url }}</a></td>
              </tr>
              {% endif %}
              {% if org.domain %}
              <tr>
                <td>Domain</td>
                <td><code>{{ org.domain }}</code></td>
              </tr>
              {% endif %}
              <tr>
                <td>Latest income</td>
                <td>
                {% if org.latestIncome %}
                  &pound;{{ "{:,.0f}".format( org.latestIncome )}}
                {% else %}
                  <code>Unknown</code>
                {% endif %}
                </td>
              </tr>
            </tbody>
          </table>
          {% for s in org.sources if sources.get(s) %}
          <p class="has-text-weight-light is-size-7">
            <strong>Data source</strong>:
            <a href="{{ sources[s].publisher.website }}" target="_blank">
              {{ sources[s].publisher.name }}
            </a><br>
            <i>Last updated {{ "{:%d %B %Y}".format(sources[s].modified) }}</i>
          </p>
          {% endfor %}
        </div>
      </div>
    </div>
    <br>
    {# {% if charity["geo"]["location"] %}
    <div class="card">
      <header class="card-header">
        <p class="card-header-title">Location</p>
      </header>
      <div class="card-content">
        <div class="content">
          <table class="table">
            <tbody>
              {% if charity.get("geo", {}).get("location") %}
              <tr>
                <th>Latitude/longitude</th>
                <td>
                  <a href="#">
                     {{ charity.get("geo", {}).get("location",{}).get("lat") }},
                     {{ charity.get("geo", {}).get("location",{}).get("lon") }}
                  </a>
                </td>
              </tr>
              {% endif %}
              <!--<tr><th>Local Authority</th><td>{{ charity.get("geo", {}).get("areas",[]) }}</td></tr>-->
              <tr><th>Postcode</th><td>{{ charity.get("geo", {}).get("postcode") }}</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {% endif %} #}

  </div>
  {% endfor %}
</div>

<div class="columns">
  <div class="column">
    <div class="card">
      <header class="card-header">
        <p class="card-header-title">Data sources</p>
      </header>
      <div class="card-content">
        <div class="content">
          <table class="table">
            <tbody>
              {% for s in orgs.sources if sources.get(s) %}
              <tr id="{{ s }}">
                <td>
                  <strong><a href="{{ sources[s].publisher.website }}">{{ sources[s].publisher.name }}</a></strong><br>
                  {% if sources[s].title != sources[s].publisher.name %}
                  {{ sources[s].title }}
                  {% endif %}
                </td>
                <td class="is-size-7">{{ sources[s].description }}</td>
                <td>{{ "{:%Y-%m-%d}".format(sources[s].modified) }}</td>
                <td><a href="{{ sources[s].license }}">{{ sources[s].license_name }}</a></td>
                <td>
                {% for d in sources[s].distribution %}
                  {% if loop.length > 1 %}
                  <li>
                  <a class="is-size-7" href="{{ d.accessURL }}">{{ d.title }}</a>
                  <a class="button is-small" href="{{ d.downloadURL }}">Download data</a>
                  </li>
                  {% else %}
                  <a class="button is-small" href="{{ d.accessURL }}">Access data</a>
                  <a class="button is-small" href="{{ d.downloadURL }}">Download data</a><br>
                  {% endif %}
                {% endfor %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}